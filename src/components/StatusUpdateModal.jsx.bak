import { useState } from 'react';
import { Play, CheckCircle, Pause, XCircle, RotateCcw, AlertTriangle, ChevronRight, Check, Camera, X, Plus } from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from './ui/Card';
import Button from './ui/Button';

const StatusUpdateModal = ({ record, onClose, onUpdate, userId }) => {
  const [selectedStatus, setSelectedStatus] = useState(null);
  const [formData, setFormData] = useState({
    notes: '',
    rootCause: '',
    actionTaken: '',
    cancelledReason: '',
    onHoldReason: ''
  });
  const [selectedImages, setSelectedImages] = useState([]);
  const [imagePreviews, setImagePreviews] = useState([]);
  const [isSubmitting, setIsSubmitting] = useState(false);

  const statusOptions = [
    {
      value: 'in_progress',
      label: record.status === 'on_hold' ? '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠' : '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô',
      icon: Play,
      color: 'bg-blue-500/20 text-blue-400 border-blue-500/30 hover:border-blue-500/50',
      iconBg: 'bg-blue-500',
      description: record.status === 'on_hold' ? '‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠' : '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£',
      disabled: record.status === 'in_progress' || record.status === 'completed'
    },
    {
      value: 'on_hold',
      label: '‡∏û‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
      icon: Pause,
      color: 'bg-orange-500/20 text-orange-400 border-orange-500/30 hover:border-orange-500/50',
      iconBg: 'bg-orange-500',
      description: '‡∏û‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà',
      disabled: record.status === 'pending' || record.status === 'completed' || record.status === 'cancelled',
      requiresReason: true
    },
    {
      value: 'completed',
      label: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
      icon: CheckCircle,
      color: 'bg-green-500/20 text-green-400 border-green-500/30 hover:border-green-500/50',
      iconBg: 'bg-green-500',
      description: '‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå',
      disabled: record.status === 'pending' || record.status === 'completed',
      requiresDetail: true
    },
    {
      value: 'cancelled',
      label: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
      icon: XCircle,
      color: 'bg-red-500/20 text-red-400 border-red-500/30 hover:border-red-500/50',
      iconBg: 'bg-red-500',
      description: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ô‡∏µ‡πâ',
      disabled: record.status === 'completed',
      requiresReason: true
    },
    {
      value: 'reopened',
      label: '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà',
      icon: RotateCcw,
      color: 'bg-purple-500/20 text-purple-400 border-purple-500/30 hover:border-purple-500/50',
      iconBg: 'bg-purple-500',
      description: '‡πÄ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà',
      disabled: record.status !== 'completed'
    }
  ];

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    // Validation for completed status - REQUIRE IMAGES
    if (selectedStatus === 'completed') {
      if (!formData.rootCause || !formData.actionTaken) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô');
        return;
      }
      if (selectedImages.length === 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÉ‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô');
        return;
      }
    }

    if (selectedStatus === 'cancelled' && !formData.cancelledReason) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å');
      return;
    }

    if (selectedStatus === 'on_hold' && !formData.onHoldReason) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
      return;
    }

    setIsSubmitting(true);
    
    try {
      // Create FormData as the backend now handles multipart for status updates
      const formDataToSend = new FormData();
      formDataToSend.append('status', selectedStatus);
      formDataToSend.append('userId', String(userId));
      formDataToSend.append('notes', formData.notes || '');
      
      if (selectedStatus === 'completed') {
        formDataToSend.append('rootCause', formData.rootCause);
        formDataToSend.append('actionTaken', formData.actionTaken);
      } else if (selectedStatus === 'cancelled') {
        formDataToSend.append('cancelledReason', formData.cancelledReason);
      } else if (selectedStatus === 'on_hold') {
        formDataToSend.append('onHoldReason', formData.onHoldReason);
      }

      // Add all images
      selectedImages.forEach(img => {
        formDataToSend.append('images', img);
      });

      await onUpdate(selectedStatus, formDataToSend);
      onClose();
    } catch (error) {
      alert(error.message);
    } finally {
      setIsSubmitting(false);
    }
  };

  const selectedOption = statusOptions.find(opt => opt.value === selectedStatus);

  return (
    <div className="fixed inset-0 z-[60] overflow-y-auto bg-black/80 backdrop-blur-sm">
      <div className="min-h-full flex items-end sm:items-center justify-center p-4">
        <Card className="max-w-2xl w-full border-gray-800 shadow-2xl animate-in fade-in slide-in-from-bottom-4 duration-300 my-8">
        
          {/* Header */}
          <CardHeader className="bg-gradient-to-r from-gray-900 to-gray-800 border-b border-gray-800 sticky top-0 z-10">
          <div className="flex justify-between items-start gap-4">
            <div>
              <CardTitle className="text-xl font-bold text-white flex items-center gap-3">
                <AlertTriangle className="w-6 h-6 text-yellow-500" />
                ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô
              </CardTitle>
              <CardDescription className="text-gray-400 mt-1">
                {record.work_order} ‚Ä¢ {record.equipment_name}
              </CardDescription>
            </div>
            <Button
              variant="icon"
              size="sm"
              onClick={onClose}
              className="text-gray-500 hover:text-white hover:bg-gray-800 rounded-xl"
            >
              <XCircle size={24} />
            </Button>
          </div>

          {/* Step Indicator */}
          {selectedStatus && (
            <div className="mt-6 flex items-center gap-4 border-t border-gray-800 pt-6">
              <div className="flex items-center gap-2">
                <div className="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center font-bold text-sm shadow-lg shadow-green-500/20">
                  <Check size={16} />
                </div>
                <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
              </div>
              <div className="h-px flex-1 bg-gray-800"></div>
              <div className="flex items-center gap-2">
                <div className="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-sm shadow-lg shadow-blue-500/20">2</div>
                <span className="text-xs font-bold text-white uppercase tracking-wider">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
              </div>
            </div>
          )}
        </CardHeader>

        <CardContent className="p-6">
          {!selectedStatus ? (
            // Status Selection Step
            <div className="space-y-4">
              <div className="flex items-center gap-3 mb-2">
                <div className="w-8 h-8 rounded-full bg-gray-800 text-gray-400 flex items-center justify-center font-bold text-sm border border-gray-700">1</div>
                <p className="text-sm font-bold text-gray-300 uppercase tracking-widest">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà</p>
              </div>
              
              <div className="grid gap-3">
                {statusOptions.map((option) => {
                  const Icon = option.icon;
                  const canUse = !option.disabled;
                  return (
                    <button
                      key={option.value}
                      onClick={() => canUse && setSelectedStatus(option.value)}
                      disabled={!canUse}
                      className={`w-full p-4 rounded-2xl border-2 transition-all text-left flex items-center gap-4 group relative overflow-hidden ${
                        !canUse
                          ? 'border-gray-800/50 bg-gray-900/30 opacity-30 cursor-not-allowed'
                          : `border-gray-800 bg-gray-900/50 hover:bg-gray-800/80 hover:border-gray-600 hover:translate-x-1`
                      }`}
                    >
                      <div className={`p-3 rounded-xl ${option.iconBg} text-white shadow-lg shadow-black/20 group-hover:scale-110 transition-transform`}>
                        <Icon size={24} />
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center justify-between">
                          <span className="font-bold text-white text-lg">{option.label}</span>
                          {canUse && <ChevronRight size={18} className="text-gray-600 group-hover:text-white transition-colors" />}
                        </div>
                        <p className="text-sm text-gray-500 mt-0.5">{option.description}</p>
                      </div>
                    </button>
                  );
                })}
              </div>
            </div>
          ) : (
            // Form Step
            <form onSubmit={handleSubmit} className="space-y-6">
              {/* Selected Status Header */}
              <div className={`rounded-2xl p-4 border flex items-center gap-4 ${selectedOption?.color}`}>
                <div className={`p-2.5 rounded-xl ${selectedOption?.iconBg} text-white shadow-lg`}>
                  {selectedOption && <selectedOption.icon size={20} />}
                </div>
                <div>
                  <p className="text-xs font-bold opacity-60 uppercase tracking-wider">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô</p>
                  <p className="text-lg font-bold">{selectedOption?.label}</p>
                </div>
              </div>

              {/* Dynamic Form Fields */}
              <div className="space-y-5 animate-in fade-in slide-in-from-top-2 duration-300">
                {selectedStatus === 'completed' && (
                  <>
                    <div className="space-y-2">
                      <label className="text-sm font-bold text-gray-400 flex items-center gap-2">
                        <span className="text-blue-400">üîç</span> ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ *
                      </label>
                      <textarea
                        required
                        value={formData.rootCause}
                        onChange={(e) => setFormData({ ...formData, rootCause: e.target.value })}
                        className="w-full px-4 py-3 bg-gray-950 border border-gray-800 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition-all min-h-[100px] text-sm resize-none"
                        placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô..."
                      />
                    </div>
                    <div className="space-y-2">
                      <label className="text-sm font-bold text-gray-400 flex items-center gap-2">
                        <span className="text-green-400">üîß</span> ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç *
                      </label>
                      <textarea
                        required
                        value={formData.actionTaken}
                        onChange={(e) => setFormData({ ...formData, actionTaken: e.target.value })}
                        className="w-full px-4 py-3 bg-gray-950 border border-gray-800 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition-all min-h-[100px] text-sm resize-none"
                        placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ..."
                      />
                    </div>
                  </>
                )}

                {selectedStatus === 'cancelled' && (
                  <div className="space-y-2">
                    <label className="text-sm font-bold text-red-400 flex items-center gap-2">
                      <XCircle size={16} /> ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å *
                    </label>
                    <textarea
                      required
                      value={formData.cancelledReason}
                      onChange={(e) => setFormData({ ...formData, cancelledReason: e.target.value })}
                      className="w-full px-4 py-3 bg-gray-950 border border-red-900/30 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-red-500 transition-all min-h-[100px] text-sm resize-none"
                      placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ..."
                    />
                  </div>
                )}

                {selectedStatus === 'on_hold' && (
                  <div className="space-y-2">
                    <label className="text-sm font-bold text-orange-400 flex items-center gap-2">
                      <Pause size={16} /> ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏Å‡∏á‡∏≤‡∏ô *
                    </label>
                    <textarea
                      required
                      value={formData.onHoldReason}
                      onChange={(e) => setFormData({ ...formData, onHoldReason: e.target.value })}
                      className="w-full px-4 py-3 bg-gray-950 border border-orange-900/30 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-orange-500 transition-all min-h-[100px] text-sm resize-none"
                      placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏≠‡∏ó‡∏µ‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç..."
                    />
                  </div>
                )}

                <div className="space-y-2">
                  <label className="text-sm font-bold text-gray-400 flex items-center gap-2">
                    <span className="text-purple-400">üìù</span> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                  </label>
                  <textarea
                    value={formData.notes}
                    onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                    className="w-full px-4 py-3 bg-gray-950 border border-gray-800 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-gray-700 transition-all min-h-[80px] text-sm resize-none"
                    placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)..."
                  />
                </div>

                {/* Multiple Image Upload UI */}
                <div className="space-y-3">
                  <label className="text-sm font-bold text-gray-400 flex items-center gap-2">
                    <Camera size={16} className="text-blue-400" />
                    ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û {selectedStatus === 'completed' && <span className="text-red-500">* (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</span>}
                  </label>
                  
                  <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                    {imagePreviews.map((preview, index) => (
                      <div key={index} className="relative aspect-square rounded-xl overflow-hidden border border-gray-800 bg-black group">
                        <img src={preview} className="w-full h-full object-cover" alt="Preview" />
                        <button 
                          type="button"
                          onClick={(e) => {
                            e.preventDefault();
                            setSelectedImages(prev => prev.filter((_, i) => i !== index));
                            setImagePreviews(prev => prev.filter((_, i) => i !== index));
                          }}
                          className="absolute top-1 right-1 p-1 bg-red-600 text-white rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity"
                        >
                          <X size={12} />
                        </button>
                      </div>
                    ))}
                    
                    {selectedImages.length < 5 && (
                      <label className="flex flex-col items-center justify-center gap-1 cursor-pointer bg-gray-900 border-2 border-dashed border-gray-800 hover:border-blue-500/50 hover:bg-gray-800/80 aspect-square rounded-xl text-gray-500 transition-all group">
                        <Plus size={20} className="group-hover:scale-110 transition-transform" />
                        <span className="text-[10px] font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ</span>
                        <input
                          type="file"
                          accept="image/*"
                          multiple
                          className="hidden"
                          onChange={(e) => {
                            const files = Array.from(e.target.files);
                            const remaining = 5 - selectedImages.length;
                            files.slice(0, remaining).forEach(file => {
                              setSelectedImages(prev => [...prev, file]);
                              const reader = new FileReader();
                              reader.onloadend = () => setImagePreviews(prev => [...prev, reader.result]);
                              reader.readAsDataURL(file);
                            });
                          }}
                        />
                      </label>
                    )}
                  </div>
                  {selectedImages.length > 0 && (
                    <p className="text-[10px] text-gray-500 font-bold uppercase tracking-wider">
                      {selectedImages.length} / 5 Images Selected
                    </p>
                  )}
                </div>
              </div>

              {/* Action Buttons */}
              <div className="flex gap-3 pt-4 border-t border-gray-800">
                <Button
                  type="button"
                  onClick={() => setSelectedStatus(null)}
                  disabled={isSubmitting}
                  variant="ghost"
                  className="flex-1 rounded-xl h-14 font-bold text-gray-400 hover:text-white"
                >
                  ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                </Button>
                <Button
                  type="submit"
                  disabled={isSubmitting}
                  className={`flex-[2] rounded-xl h-14 font-bold text-white shadow-xl ${
                    isSubmitting ? 'bg-gray-800' : `${selectedOption?.iconBg} hover:opacity-90`
                  }`}
                >
                  {isSubmitting ? (
                    <span className="flex items-center justify-center gap-2">
                      <span className="animate-spin text-xl">‚è≥</span>
                      ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...
                    </span>
                  ) : (
                    <span className="flex items-center justify-center gap-2">
                      <Check size={20} />
                      ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
                    </span>
                  )}
                </Button>
              </div>
            </form>
          )}
        </CardContent>
        </Card>
      </div>
    </div>
  );
};

export default StatusUpdateModal;
